<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assignment Partitioner • rquery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Assignment Partitioner">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rquery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AssigmentPartitioner.html">Assignment Partitioner</a>
    </li>
    <li>
      <a href="../articles/Parameterized_rquery.html">Parameterized rquery</a>
    </li>
    <li>
      <a href="../articles/PipeableSQL.html">Pipeable SQL</a>
    </li>
    <li>
      <a href="../articles/QueryGeneration.html">Query Generation</a>
    </li>
    <li>
      <a href="../articles/R_mapping.html">R mapping</a>
    </li>
    <li>
      <a href="../articles/rquery_intro.html">rquery Introduction</a>
    </li>
    <li>
      <a href="../articles/rquery_substitution.html">rquery Substitution</a>
    </li>
    <li>
      <a href="../articles/sql_quoting.html">SQL quoting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/WinVector/rquery">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Assignment Partitioner</h1>
                        <h4 class="author">John Mount, Win-Vector LLC</h4>
            
            <h4 class="date">2019-10-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/rquery/blob/master/vignettes/AssigmentPartitioner.Rmd"><code>vignettes/AssigmentPartitioner.Rmd</code></a></small>
      <div class="hidden name"><code>AssigmentPartitioner.Rmd</code></div>

    </div>

    
    
<p><code><a href="../reference/extend_se.html">rquery::extend_se()</a></code> and <code><a href="../reference/extend.html">rquery::extend()</a></code> each automatically partition a sequence of assignments so that no statement is using any value created in the same partition element or group. This is to eliminate potentially dangerous ambiguity in statements.</p>
<p>For such a partition: the evaluation result does not depend on the order of execution of the statements in each group (as they are all independent of each other’s left-hand-sides). A no-dependency small number of groups partition is <em>very</em> helpful when executing expressions on <code>SQL</code> based data interfaces (such as <code>Apache Spark</code>).</p>
<p>The method used to partition expressions is to scan the remaining expressions in order taking any that: have all their values available from earlier groups, do not use a value formed in the current group, and do not overwrite a value formed in the current group.</p>
<p>This partitioning method ensures safe and correct results, and can lead to far fewer groups (and much more efficient queries) than the straightforward method of breaking up the sequence of expressions at each new-value use.</p>
<p>Here is a non-trivial database based example (demonstrating methods that might be used in big data work such as with <code>Spark</code>). We are going to assign pairs of items to complimentary treatment (“T”) and control (“C”) groups based on already populated pseudo-random numbers (pre-populating the pseudo-random numbers is to avoid <a href="https://winvector.github.io/rquery/reference/if_else_block.html">known issues in using <code>rand()</code> in <code>RSQlite</code></a>, and would not be necessary with other databases).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">run_vignette &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"DBI"</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"RSQLite"</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"rquery"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co"># example data</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">3463</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">d &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">id =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="cf">for</span>(group <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'c'</span>, <span class="st">'d'</span>, <span class="st">'e'</span>)) {</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  d[[<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"rand_"</span>, group)]] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(d))</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">my_db &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbConnect.html">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/RSQLite/man/SQLite.html">SQLite</a></span>(), </a>
<a class="sourceLine" id="cb2-10" data-line-number="10">                        <span class="st">":memory:"</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">d1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rq_copy_to.html">rq_copy_to</a></span>(my_db, <span class="st">"example_table"</span>, d)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">d1 <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="../reference/to_sql.html">to_sql</a></span>(., my_db) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="st">  </span>DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbGetQuery.html">dbGetQuery</a></span>(my_db, .) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(.)</a></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="right">rand_a</th>
<th align="right">rand_b</th>
<th align="right">rand_c</th>
<th align="right">rand_d</th>
<th align="right">rand_e</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.8438177</td>
<td align="right">0.9459773</td>
<td align="right">0.2941489</td>
<td align="right">0.1054046</td>
<td align="right">0.3038159</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.9045364</td>
<td align="right">0.4839231</td>
<td align="right">0.4654982</td>
<td align="right">0.6617276</td>
<td align="right">0.9056346</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.5496617</td>
<td align="right">0.6112306</td>
<td align="right">0.6989960</td>
<td align="right">0.6536909</td>
<td align="right">0.1683751</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.6545816</td>
<td align="right">0.6593733</td>
<td align="right">0.9678277</td>
<td align="right">0.8316179</td>
<td align="right">0.0597492</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># design the experiment </span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">plan &lt;-<span class="st"> </span>d1 <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend</a></span>(.,</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">   <span class="dt">choice_a =</span> rand_a<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="dt">a_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_a, </a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="dt">a_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_a, </a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">   <span class="dt">choice_b =</span> rand_b<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb3-12" data-line-number="12">    <span class="dt">b_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_b, </a>
<a class="sourceLine" id="cb3-13" data-line-number="13">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb3-14" data-line-number="14">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">    <span class="dt">b_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_b, </a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">   <span class="dt">choice_c =</span> rand_c<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    <span class="dt">c_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_c, </a>
<a class="sourceLine" id="cb3-20" data-line-number="20">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb3-21" data-line-number="21">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">    <span class="dt">c_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_c, </a>
<a class="sourceLine" id="cb3-23" data-line-number="23">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb3-24" data-line-number="24">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">   <span class="dt">choice_d =</span> rand_d<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb3-26" data-line-number="26">    <span class="dt">d_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_d, </a>
<a class="sourceLine" id="cb3-27" data-line-number="27">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb3-28" data-line-number="28">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">    <span class="dt">d_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_d, </a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb3-31" data-line-number="31">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">   <span class="dt">choice_e =</span> rand_e<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb3-33" data-line-number="33">    <span class="dt">e_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_e, </a>
<a class="sourceLine" id="cb3-34" data-line-number="34">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb3-35" data-line-number="35">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">    <span class="dt">e_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice_e, </a>
<a class="sourceLine" id="cb3-37" data-line-number="37">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb3-38" data-line-number="38">                  <span class="st">'T'</span>)</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">  ) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="st">  </span><span class="kw"><a href="../reference/select_columns.html">select_columns</a></span>(., </a>
<a class="sourceLine" id="cb3-41" data-line-number="41">                 <span class="kw"><a href="https://rdrr.io/pkg/wrapr/man/qc.html">qc</a></span>(id,</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">                    a_<span class="dv">1</span>, a_<span class="dv">2</span>, b_<span class="dv">1</span>, b_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">                    c_<span class="dv">1</span>, c_<span class="dv">2</span>, d_<span class="dv">1</span>, d_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">                    e_<span class="dv">1</span>, e_<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb3-45" data-line-number="45"></a>
<a class="sourceLine" id="cb3-46" data-line-number="46"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(plan))</a></code></pre></div>
<pre><code>mk_td("example_table", c(
  "id",
  "rand_a",
  "rand_b",
  "rand_c",
  "rand_d",
  "rand_e")) %.&gt;%
 extend(.,
  choice_a := rand_a &gt;= 0.5,
  choice_b := rand_b &gt;= 0.5,
  choice_c := rand_c &gt;= 0.5,
  choice_d := rand_d &gt;= 0.5,
  choice_e := rand_e &gt;= 0.5) %.&gt;%
 extend(.,
  a_1 := ifelse(choice_a, "T", "C"),
  a_2 := ifelse(choice_a, "C", "T"),
  b_1 := ifelse(choice_b, "T", "C"),
  b_2 := ifelse(choice_b, "C", "T"),
  c_1 := ifelse(choice_c, "T", "C"),
  c_2 := ifelse(choice_c, "C", "T"),
  d_1 := ifelse(choice_d, "T", "C"),
  d_2 := ifelse(choice_d, "C", "T"),
  e_1 := ifelse(choice_e, "T", "C"),
  e_2 := ifelse(choice_e, "C", "T")) %.&gt;%
 select_columns(., 
    c('id', 'a_1', 'a_2', 'b_1', 'b_2', 'c_1', 'c_2', 'd_1', 'd_2', 'e_1', 'e_2'))</code></pre>
<p>Notice <code><a href="../reference/extend_se.html">rquery::extend_se()</a></code> split the work into 3 unambiguous groups. The statements inside each group can now be executed in any order (or even in parallel) with no ambiguity of meaning or risk of error. The goal was: split into a small number of groups such that the observable execution semantics are very close to executing the original statements in order in completely separate groups (which is likely what a user intends).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">sql &lt;-<span class="st"> </span><span class="kw"><a href="../reference/to_sql.html">to_sql</a></span>(plan, my_db)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(sql)</a></code></pre></div>
<pre><code>SELECT
 `id`,
 `a_1`,
 `a_2`,
 `b_1`,
 `b_2`,
 `c_1`,
 `c_2`,
 `d_1`,
 `d_2`,
 `e_1`,
 `e_2`
FROM (
 SELECT
  `id`,
  ( CASE WHEN ( `choice_a` ) THEN ( 'T' ) WHEN NOT ( `choice_a` ) THEN ( 'C' ) ELSE NULL END )  AS `a_1`,
  ( CASE WHEN ( `choice_a` ) THEN ( 'C' ) WHEN NOT ( `choice_a` ) THEN ( 'T' ) ELSE NULL END )  AS `a_2`,
  ( CASE WHEN ( `choice_b` ) THEN ( 'T' ) WHEN NOT ( `choice_b` ) THEN ( 'C' ) ELSE NULL END )  AS `b_1`,
  ( CASE WHEN ( `choice_b` ) THEN ( 'C' ) WHEN NOT ( `choice_b` ) THEN ( 'T' ) ELSE NULL END )  AS `b_2`,
  ( CASE WHEN ( `choice_c` ) THEN ( 'T' ) WHEN NOT ( `choice_c` ) THEN ( 'C' ) ELSE NULL END )  AS `c_1`,
  ( CASE WHEN ( `choice_c` ) THEN ( 'C' ) WHEN NOT ( `choice_c` ) THEN ( 'T' ) ELSE NULL END )  AS `c_2`,
  ( CASE WHEN ( `choice_d` ) THEN ( 'T' ) WHEN NOT ( `choice_d` ) THEN ( 'C' ) ELSE NULL END )  AS `d_1`,
  ( CASE WHEN ( `choice_d` ) THEN ( 'C' ) WHEN NOT ( `choice_d` ) THEN ( 'T' ) ELSE NULL END )  AS `d_2`,
  ( CASE WHEN ( `choice_e` ) THEN ( 'T' ) WHEN NOT ( `choice_e` ) THEN ( 'C' ) ELSE NULL END )  AS `e_1`,
  ( CASE WHEN ( `choice_e` ) THEN ( 'C' ) WHEN NOT ( `choice_e` ) THEN ( 'T' ) ELSE NULL END )  AS `e_2`
 FROM (
  SELECT
   `id`,
   `rand_a` &gt;= 0.5  AS `choice_a`,
   `rand_b` &gt;= 0.5  AS `choice_b`,
   `rand_c` &gt;= 0.5  AS `choice_c`,
   `rand_d` &gt;= 0.5  AS `choice_d`,
   `rand_e` &gt;= 0.5  AS `choice_e`
  FROM (
   SELECT
    `id`,
    `rand_a`,
    `rand_b`,
    `rand_c`,
    `rand_d`,
    `rand_e`
   FROM
    `example_table`
   ) tsql_59110515983599244008_0000000000
  ) tsql_59110515983599244008_0000000001
) tsql_59110515983599244008_0000000002</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbGetQuery.html">dbGetQuery</a></span>(my_db, sql) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(.)</a></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="left">a_1</th>
<th align="left">a_2</th>
<th align="left">b_1</th>
<th align="left">b_2</th>
<th align="left">c_1</th>
<th align="left">c_2</th>
<th align="left">d_1</th>
<th align="left">d_2</th>
<th align="left">e_1</th>
<th align="left">e_2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
</tbody>
</table>
<p>A straightforward method (with no statement re-ordering) of splitting into non-dependent groups would have to split the mutate at each first use of a new value: yielding more mutate stages. For why a low number of execution stages is important please see <a href="http://winvector.github.io/FluidData/partition_mutate.html">here</a>.</p>
<p>Note: re-using variable variable names does limit the planner’s ability to efficiently partition the the statement. The planner still emits safe and correct code, but unless it were to be allowed to introduce new variable names it must break sequences in more places. We show this effect below:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">plan2 &lt;-<span class="st"> </span>d1 <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend</a></span>(.,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">   <span class="dt">choice =</span> rand_a<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="dt">a_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-5" data-line-number="5">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb8-6" data-line-number="6">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">    <span class="dt">a_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-8" data-line-number="8">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb8-9" data-line-number="9">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">   <span class="dt">choice =</span> rand_b<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb8-11" data-line-number="11">    <span class="dt">b_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-12" data-line-number="12">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb8-13" data-line-number="13">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    <span class="dt">b_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-15" data-line-number="15">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb8-16" data-line-number="16">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">   <span class="dt">choice =</span> rand_c<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb8-18" data-line-number="18">    <span class="dt">c_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-19" data-line-number="19">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb8-20" data-line-number="20">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">    <span class="dt">c_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-22" data-line-number="22">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb8-23" data-line-number="23">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb8-24" data-line-number="24">   <span class="dt">choice =</span> rand_d<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb8-25" data-line-number="25">    <span class="dt">d_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-26" data-line-number="26">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb8-27" data-line-number="27">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb8-28" data-line-number="28">    <span class="dt">d_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-29" data-line-number="29">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb8-30" data-line-number="30">                  <span class="st">'T'</span>),</a>
<a class="sourceLine" id="cb8-31" data-line-number="31">   <span class="dt">choice =</span> rand_e<span class="op">&gt;=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb8-32" data-line-number="32">    <span class="dt">e_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-33" data-line-number="33">                  <span class="st">'T'</span>, </a>
<a class="sourceLine" id="cb8-34" data-line-number="34">                  <span class="st">'C'</span>),</a>
<a class="sourceLine" id="cb8-35" data-line-number="35">    <span class="dt">e_2 =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(choice, </a>
<a class="sourceLine" id="cb8-36" data-line-number="36">                  <span class="st">'C'</span>, </a>
<a class="sourceLine" id="cb8-37" data-line-number="37">                  <span class="st">'T'</span>)</a>
<a class="sourceLine" id="cb8-38" data-line-number="38">  ) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb8-39" data-line-number="39"><span class="st">  </span><span class="kw"><a href="../reference/select_columns.html">select_columns</a></span>(., </a>
<a class="sourceLine" id="cb8-40" data-line-number="40">                 <span class="kw"><a href="https://rdrr.io/pkg/wrapr/man/qc.html">qc</a></span>(id,</a>
<a class="sourceLine" id="cb8-41" data-line-number="41">                    a_<span class="dv">1</span>, a_<span class="dv">2</span>, b_<span class="dv">1</span>, b_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb8-42" data-line-number="42">                    c_<span class="dv">1</span>, c_<span class="dv">2</span>, d_<span class="dv">1</span>, d_<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb8-43" data-line-number="43">                    e_<span class="dv">1</span>, e_<span class="dv">2</span>))</a></code></pre></div>
<pre><code>Warning in extend_impl_list(source = source, parsed = parsed, partitionby
= partitionby, : rquery:::extend_impl_list assigned same column more than
once in an extend</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(plan2))</a></code></pre></div>
<pre><code>mk_td("example_table", c(
  "id",
  "rand_a",
  "rand_b",
  "rand_c",
  "rand_d",
  "rand_e")) %.&gt;%
 extend(.,
  choice := rand_a &gt;= 0.5) %.&gt;%
 extend(.,
  a_1 := ifelse(choice, "T", "C"),
  a_2 := ifelse(choice, "C", "T")) %.&gt;%
 extend(.,
  choice := rand_b &gt;= 0.5) %.&gt;%
 extend(.,
  b_1 := ifelse(choice, "T", "C"),
  b_2 := ifelse(choice, "C", "T")) %.&gt;%
 extend(.,
  choice := rand_c &gt;= 0.5) %.&gt;%
 extend(.,
  c_1 := ifelse(choice, "T", "C"),
  c_2 := ifelse(choice, "C", "T")) %.&gt;%
 extend(.,
  choice := rand_d &gt;= 0.5) %.&gt;%
 extend(.,
  d_1 := ifelse(choice, "T", "C"),
  d_2 := ifelse(choice, "C", "T")) %.&gt;%
 extend(.,
  choice := rand_e &gt;= 0.5) %.&gt;%
 extend(.,
  e_1 := ifelse(choice, "T", "C"),
  e_2 := ifelse(choice, "C", "T")) %.&gt;%
 select_columns(., 
    c('id', 'a_1', 'a_2', 'b_1', 'b_2', 'c_1', 'c_2', 'd_1', 'd_2', 'e_1', 'e_2'))</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">sql2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/to_sql.html">to_sql</a></span>(plan2, my_db)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbGetQuery.html">dbGetQuery</a></span>(my_db, sql2) <span class="op">%.&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(.)</a></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="left">a_1</th>
<th align="left">a_2</th>
<th align="left">b_1</th>
<th align="left">b_2</th>
<th align="left">c_1</th>
<th align="left">c_2</th>
<th align="left">d_1</th>
<th align="left">d_2</th>
<th align="left">e_1</th>
<th align="left">e_2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">T</td>
<td align="left">C</td>
<td align="left">C</td>
<td align="left">T</td>
</tr>
</tbody>
</table>
<p>Notice the returned tables are identical (as they should be, <a href="https://github.com/WinVector/rquery/blob/master/extras/AssigmentPartitioner.md#dplyr-example">which is not always the case for database backed <code>dplyr</code></a>).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">DBI<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DBI/man/dbDisconnect.html">dbDisconnect</a></span>(my_db)</a></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Mount.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
