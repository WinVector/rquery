<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rquery Introduction • rquery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="rquery Introduction">
<meta property="og:description" content="rquery">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rquery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.4.99</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AssigmentPartitioner.html">Assignment Partitioner</a>
    </li>
    <li>
      <a href="../articles/Parameterized_rquery.html">Parameterized rquery</a>
    </li>
    <li>
      <a href="../articles/PipeableSQL.html">Pipeable SQL</a>
    </li>
    <li>
      <a href="../articles/QueryGeneration.html">Query Generation</a>
    </li>
    <li>
      <a href="../articles/R_mapping.html">R mapping</a>
    </li>
    <li>
      <a href="../articles/rquery_intro.html">rquery Introduction</a>
    </li>
    <li>
      <a href="../articles/rquery_many_columns.html">rquery Many Columns</a>
    </li>
    <li>
      <a href="../articles/sql_quoting.html">SQL quoting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://win-vector.com/" class="external-link">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>rquery Introduction</h1>
                        <h4 data-toc-skip class="author">John Mount,
Win-Vector LLC</h4>
            
            <h4 data-toc-skip class="date">2023-08-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/rquery/blob/HEAD/vignettes/rquery_intro.Rmd" class="external-link"><code>vignettes/rquery_intro.Rmd</code></a></small>
      <div class="hidden name"><code>rquery_intro.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://github.com/WinVector/rquery" class="external-link"><code>rquery</code></a>
is a query generator for <a href="https://www.r-project.org" class="external-link"><code>R</code></a>. It is based on <a href="https://en.wikipedia.org/wiki/Relational_algebra" class="external-link">Edgar F. Codd’s
relational algebra</a> plus experience using <code>SQL</code> and <a href="https://CRAN.R-project.org/package=dplyr" class="external-link"><code>dplyr</code></a>
at big data scale. The design represents an attempt to make
<code>SQL</code> more teachable by denoting composition by a sequential
pipeline notation instead of nested queries or functions. The
implementation delivers reliable high performance data processing on
large data systems such as <code>Spark</code> and databases. Package
features include: data processing trees or pipelines as observable
objects (able to report both columns produced and columns used),
optimized <code>SQL</code> generation as an explicit user visible
modeling step, convenience methods for applying query trees to in-memory
<code>data.frame</code>s, and low direct package dependencies.</p>
<p>Let’s set up our environment so we can work with examples.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_vignette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"DBI"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"RSQLite"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/WinVector/rquery/" class="external-link">"rquery"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: wrapr</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/WinVector/wrapr" class="external-link">"wrapr"</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example database connection</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     <span class="st">":memory:"</span><span class="op">)</span></span>
<span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/initExtension.html" class="external-link">initExtension</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># adapt to database</span></span>
<span><span class="va">dbopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rq_connection_tests.html">rq_connection_tests</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">dbopts</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># register database</span></span>
<span><span class="va">old_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"rquery.rquery_db_executor"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>db <span class="op">=</span> <span class="va">db</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="table-descriptions">Table descriptions<a class="anchor" aria-label="anchor" href="#table-descriptions"></a>
</h2>
<p><code>rquery</code> table descriptions are simple objects that store
only the name of a table and expected columns. Any local data or
database table that has at least the set of columns named in the table
description can be used in a given <code>rquery</code> pipeline.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># copy in example data</span></span>
<span><span class="fu"><a href="../reference/rq_copy_to.html">rq_copy_to</a></span><span class="op">(</span></span>
<span>  <span class="va">db</span>, <span class="st">'d'</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  temporary <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mk_td(\"d\", c( \"v\"))"</span></span>
<span><span class="co">##    v</span></span>
<span><span class="co">## 1  1</span></span>
<span><span class="co">## 2 -5</span></span>
<span><span class="co">## 3  3</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># produce a hande to existing table</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_td.html">db_td</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">"d"</span><span class="op">)</span></span></code></pre></div>
<p>The table description “<code>d</code>” we have been using in examples
was produced as a result of moving data to a database by <a href="https://winvector.github.io/rquery/reference/rq_copy_to.html" class="external-link"><code>rq_copy_to()</code></a>.
However we can also create a description of an existing database table
with <a href="https://winvector.github.io/rquery/reference/db_td.html" class="external-link"><code>db_td()</code></a>
or even build a description by hand with <a href="https://winvector.github.io/rquery/reference/mk_td.html" class="external-link"><code>mk_td()</code></a>.
Also one can build descriptions of local or in-memory
<code>data.frame</code>s with <a href="https://winvector.github.io/rquery/reference/local_td.html" class="external-link"><code>local_td()</code></a>.</p>
</div>
<div class="section level2">
<h2 id="operators">Operators<a class="anchor" aria-label="anchor" href="#operators"></a>
</h2>
<p>The <a href="https://winvector.github.io/rquery/reference/sql_node.html" class="external-link"><code>sql_node()</code></a>
alone can make writing, understanding, and maintaining complex data
transformations as queries easier. And this node is a good introduction
to some of the power of the <code>rquery</code> package. However, the
primary purpose of <code>rquery</code> is to provide ready-made
relational operators to further simplify to the point of rarely needing
to use the <code><a href="../reference/sql_node.html">sql_node()</a></code> directly.</p>
<p>The primary operators supplied by <code>rquery</code> are:</p>
<p>The primary relational operators include:</p>
<ul>
<li>
<a href="https://winvector.github.io/rquery/reference/extend.html" class="external-link"><code>extend()</code></a>/<a href="https://winvector.github.io/rquery/reference/extend_se.html" class="external-link"><code>extend_se()</code></a>.
Extend adds derived columns to a relation table. With a sufficiently
powerful <code>SQL</code> provider this includes ordered and partitioned
window functions. This operator also includes built-in <a href="https://winvector.github.io/seplyr/" class="external-link"><code>seplyr</code></a>-style
<a href="https://winvector.github.io/seplyr/articles/MutatePartitioner.html" class="external-link">assignment
partitioning</a>.</li>
<li>
<a href="https://winvector.github.io/rquery/reference/project.html" class="external-link"><code>project()</code></a>.
Project is usually <em>portrayed</em> as the equivalent to column
selection, though the original definition includes aggregation. In our
opinion the original relational nature of the operator is best captured
by moving <code>SQL</code>’s “<code>GROUP BY</code>” aggregation
functionality.</li>
<li>
<a href="https://winvector.github.io/rquery/reference/natural_join.html" class="external-link"><code>natural_join()</code></a>.
This a specialized relational join operator, using all common columns as
an equi-join condition.</li>
<li>
<a href="https://winvector.github.io/rquery/reference/theta_join.html" class="external-link"><code>theta_join()</code></a>.
This is the relational join operator allowing an arbitrary
predicate.</li>
<li>
<a href="https://winvector.github.io/rquery/reference/theta_join.html" class="external-link"><code>select_rows()</code></a>.
This is Codd’s relational row selection. Obviously <code>select</code>
alone is an over-used and now ambiguous term (for example: it is already
used as the “doit” verb in <code>SQL</code> and the <em>column</em>
selector in <code>dplyr</code>).</li>
<li>
<a href="https://winvector.github.io/rquery/reference/rename_columns.html" class="external-link"><code>rename_columns()</code></a>.
This operator renames sets of columns.</li>
</ul>
<p>The primary non-relational (traditional <code>SQL</code>) operators
are:</p>
<ul>
<li>
<a href="https://winvector.github.io/rquery/reference/select_columns.html" class="external-link"><code>select_columns()</code></a>.
This allows choice of columns (central to <code>SQL</code>), but is not
a relational operator as it can damage row-uniqueness.</li>
<li>
<a href="https://winvector.github.io/rquery/reference/orderby.html" class="external-link"><code>orderby()</code></a>.
Row order is not a concept in the relational algebra (and also not
maintained in most <code>SQL</code> implementations). This operator is
only useful when used with its <code>limit=</code> option, or as the
last step as data comes out of the relation store and is moved to
<code>R</code> (where row-order is usually maintained).</li>
</ul>
<p>The above list (and especially naming) are chosen to first match
Codd’s relational concepts (<code>project</code>, <code>select</code>,
<code>rename</code>, <code>join</code>, aggregation), <code>SQL</code>
naming conventions. Notice this covers the <a href="https://dplyr.tidyverse.org" class="external-link">primary <code>dplyr</code>
operators</a> <code>mutate()</code> (Codd’s <code>extend</code>),
<code>select()</code> (not relational), <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code> (Codd’s
<code>select</code>, represented in <code>SQL</code> by
“<code>WHERE</code>”), <code>summarise()</code> (Codd’s
<code>project</code> or aggregate concepts, triggered in
<code>SQL</code> by “<code>GROUP BY</code>”), <code>arrange()</code>
(not a relational concept, implemented in <code>SQL</code> by “ORDER
BY”). This correspondence is due to Codd’s ideas and <code>SQL</code>
driving data engineering thinking for almost the last 50 years (both
with and without credit or citation).</p>
<p>With relational operators the user can work fast and work further
away from syntactic details. For example some <code>R</code> operators
(such as <code>is.na</code>) are translated to <code>SQL</code>
analogues (in this case <code>IS NULL</code>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/extend.html">extend</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">was_na</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/to_sql.html">to_sql</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">db</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SELECT</span></span>
<span><span class="co">##  `v`,</span></span>
<span><span class="co">##  ( CASE WHEN ( ( ( `v` ) IS NULL ) ) THEN ( 1 ) WHEN NOT ( ( ( `v` ) IS NULL ) ) THEN ( 0 ) ELSE NULL END )  AS `was_na`</span></span>
<span><span class="co">## FROM (</span></span>
<span><span class="co">##  SELECT</span></span>
<span><span class="co">##   `v`</span></span>
<span><span class="co">##  FROM</span></span>
<span><span class="co">##   `d`</span></span>
<span><span class="co">##  ) tsql_98354923887583472047_0000000000</span></span></code></pre>
<p>The exact translation depends on the database (which is why
<code><a href="../reference/to_sql.html">to_sql()</a></code> takes a database argument). Some care has to be
taken as <code>SQL</code> types are different than <code>R</code> types
(in particular for some databases logical types are not numeric).</p>
<p>With a database that supplies window functions one can quickly work
the “logistic scoring by hand” example from<br>
from <a href="https://win-vector.com/2017/08/04/lets-have-some-sympathy-for-the-part-time-r-user/" class="external-link">Let’s
Have Some Sympathy For The Part-time R User</a>. This example worked
with <code>rquery</code> code that works with both
<code>PostgreSQL</code> and <code>Spark</code> can be found <a href="https://github.com/WinVector/rquery/blob/master/README.md" class="external-link">here</a>.</p>
<p>We can demonstrate the pipeline, but the <code>SQLite</code> database
we are using in this vignette does not have the window functions
required to execute it. <code>PostgreSQL</code>, <code>Spark</code>, and
many other databases do have the necessary functionality. The pipeline
is a good example of a non-trivial sequence of relational nodes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">0.237</span></span>
<span></span>
<span><span class="va">dq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_td.html">mk_td</a></span><span class="op">(</span><span class="st">"d3"</span>, </span>
<span>                   columns <span class="op">=</span> <span class="fu"><a href="https://winvector.github.io/wrapr//reference/qc.html" class="external-link">qc</a></span><span class="op">(</span><span class="va">subjectID</span>, </span>
<span>                                <span class="va">surveyCategory</span>, </span>
<span>                                <span class="va">assessmentTotal</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extend.html">extend</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>             <span class="va">probability</span> <span class="op">:=</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">assessmentTotal</span> <span class="op">*</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/normalize_cols.html">normalize_cols</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                 <span class="st">"probability"</span>,</span>
<span>                 partitionby <span class="op">=</span> <span class="st">'subjectID'</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pick_top_k.html">pick_top_k</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>             partitionby <span class="op">=</span> <span class="st">'subjectID'</span>,</span>
<span>             orderby <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'probability'</span>, <span class="st">'surveyCategory'</span><span class="op">)</span>,</span>
<span>             reverse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'probability'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/rename_columns.html">rename_columns</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">'diagnosis'</span> <span class="op">:=</span> <span class="st">'surveyCategory'</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/select_columns.html">select_columns</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'subjectID'</span>, </span>
<span>                      <span class="st">'diagnosis'</span>, </span>
<span>                      <span class="st">'probability'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/orderby.html">orderby</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">'subjectID'</span><span class="op">)</span></span></code></pre></div>
<p><a href="https://winvector.github.io/wrapr/reference/qc.html" class="external-link"><code>qc()</code></a>
is “quoting concatenate”, a convenience function that lets us skip a few
quote marks. No <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, <code><a href="https://rdrr.io/r/base/name.html" class="external-link">as.name()</a></code>, or
<code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote()</a></code> steps are needed as the operator nodes are parsed
by <code>R</code> to find identifiers. The <code>scale</code> constant
was added to the environment as pipelines try to bind constants during
pipe construction (else <code>scale</code> would be estimated to be a
missing column name).</p>
<p>Even though we are not going to run this query here, we can still
check some properties of the query.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tables_used.html">tables_used</a></span><span class="op">(</span><span class="va">dq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "d3"</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/columns_used.html">columns_used</a></span><span class="op">(</span><span class="va">dq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $d3</span></span>
<span><span class="co">## [1] "subjectID"       "surveyCategory"  "assessmentTotal"</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/column_names.html">column_names</a></span><span class="op">(</span><span class="va">dq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "subjectID"   "diagnosis"   "probability"</span></span></code></pre>
<p>The operations can be printed as an operations tree.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">dq</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## mk_td("d3", c(</span></span>
<span><span class="co">##   "subjectID",</span></span>
<span><span class="co">##   "surveyCategory",</span></span>
<span><span class="co">##   "assessmentTotal")) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   probability := exp(assessmentTotal * 0.237)) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   probability := probability / sum(probability),</span></span>
<span><span class="co">##   partitionby = c('subjectID'),</span></span>
<span><span class="co">##   orderby = c(),</span></span>
<span><span class="co">##   reverse = c()) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   row_number := row_number(),</span></span>
<span><span class="co">##   partitionby = c('subjectID'),</span></span>
<span><span class="co">##   orderby = c('probability', 'surveyCategory'),</span></span>
<span><span class="co">##   reverse = c('probability')) %.&gt;%</span></span>
<span><span class="co">##  select_rows(.,</span></span>
<span><span class="co">##    row_number &lt;= 1) %.&gt;%</span></span>
<span><span class="co">##  rename_columns(.,</span></span>
<span><span class="co">##   c('diagnosis' = 'surveyCategory')) %.&gt;%</span></span>
<span><span class="co">##  select_columns(., </span></span>
<span><span class="co">##     c('subjectID', 'diagnosis', 'probability')) %.&gt;%</span></span>
<span><span class="co">##  order_rows(.,</span></span>
<span><span class="co">##   c('subjectID'),</span></span>
<span><span class="co">##   reverse = c(),</span></span>
<span><span class="co">##   limit = NULL)</span></span></code></pre>
<p>Notice the returned presentation is not exactly the set of nodes we
specified. This is because of the nodes we used
(<code><a href="../reference/normalize_cols.html">normalize_cols()</a></code> and <code><a href="../reference/pick_top_k.html">pick_top_k()</a></code>) are
actually higher-order nodes (implemented in terms of nodes). Also
<code><a href="../reference/extend.html">extend()</a></code> nodes are re-factored to be unambiguous in their
use and re-use of column names.</p>
<p>We can also exhibit the <code>SQL</code> this operations tree
renders, to (though the <code>SQLite</code> database we are using in
vignettes does not have the required window-functions to execute it; we
suggest using <code>PostgreSQL</code>).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="../reference/to_sql.html">to_sql</a></span><span class="op">(</span><span class="va">dq</span>, <span class="va">db</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SELECT * FROM (</span></span>
<span><span class="co">##  SELECT</span></span>
<span><span class="co">##   `subjectID`,</span></span>
<span><span class="co">##   `diagnosis`,</span></span>
<span><span class="co">##   `probability`</span></span>
<span><span class="co">##  FROM (</span></span>
<span><span class="co">##   SELECT</span></span>
<span><span class="co">##    `subjectID` AS `subjectID`,</span></span>
<span><span class="co">##    `surveyCategory` AS `diagnosis`,</span></span>
<span><span class="co">##    `probability` AS `probability`</span></span>
<span><span class="co">##   FROM (</span></span>
<span><span class="co">##    SELECT * FROM (</span></span>
<span><span class="co">##     SELECT</span></span>
<span><span class="co">##      `subjectID`,</span></span>
<span><span class="co">##      `surveyCategory`,</span></span>
<span><span class="co">##      `probability`,</span></span>
<span><span class="co">##      row_number ( ) OVER (  PARTITION BY `subjectID` ORDER BY `probability` DESC, `surveyCategory` ) AS `row_number`</span></span>
<span><span class="co">##     FROM (</span></span>
<span><span class="co">##      SELECT</span></span>
<span><span class="co">##       `subjectID`,</span></span>
<span><span class="co">##       `surveyCategory`,</span></span>
<span><span class="co">##       `probability` / sum ( `probability` ) OVER (  PARTITION BY `subjectID` ) AS `probability`</span></span>
<span><span class="co">##      FROM (</span></span>
<span><span class="co">##       SELECT</span></span>
<span><span class="co">##        `subjectID`,</span></span>
<span><span class="co">##        `surveyCategory`,</span></span>
<span><span class="co">##        exp ( `assessmentTotal` * 0.237 )  AS `probability`</span></span>
<span><span class="co">##       FROM (</span></span>
<span><span class="co">##        SELECT</span></span>
<span><span class="co">##         `subjectID`,</span></span>
<span><span class="co">##         `surveyCategory`,</span></span>
<span><span class="co">##         `assessmentTotal`</span></span>
<span><span class="co">##        FROM</span></span>
<span><span class="co">##         `d3`</span></span>
<span><span class="co">##        ) tsql_67829464467022084341_0000000000</span></span>
<span><span class="co">##       ) tsql_67829464467022084341_0000000001</span></span>
<span><span class="co">##      ) tsql_67829464467022084341_0000000002</span></span>
<span><span class="co">##    ) tsql_67829464467022084341_0000000003</span></span>
<span><span class="co">##    WHERE `row_number` &lt;= 1</span></span>
<span><span class="co">##   ) tsql_67829464467022084341_0000000004</span></span>
<span><span class="co">##  ) tsql_67829464467022084341_0000000005</span></span>
<span><span class="co">## ) tsql_67829464467022084341_0000000006 ORDER BY `subjectID`</span></span></code></pre>
<p>The above query is long, but actually quite performant.</p>
<p>To see the query executed, please see <a href="https://github.com/WinVector/rquery/blob/master/README.md" class="external-link">here</a>.</p>
</div>
<div class="section level2">
<h2 id="non-sql-nodes">Non-<code>SQL</code> nodes<a class="anchor" aria-label="anchor" href="#non-sql-nodes"></a>
</h2>
<p>Not all data transform steps can conveniently be written as a single
<code>SQL</code> statement. To work around this potential limitation
<code>rquery</code> supplies a special type of node called <a href="https://winvector.github.io/rquery/reference/non_sql_node.html" class="external-link"><code>non_sql_node()</code></a>.
<code><a href="../reference/non_sql_node.html">non_sql_node()</a></code> is used to implement arbitrary table to
table transforms as <code>rquery</code> pipeline steps. Two prototypical
<code><a href="../reference/non_sql_node.html">non_sql_node()</a></code> is <a href="https://winvector.github.io/rquery/reference/rsummary_node.html" class="external-link"><code>rsummary_node()</code></a>.</p>
<p><code><a href="../reference/rsummary_node.html">rsummary_node()</a></code> builds a table of summary information
about another database table. The format is each column of the original
table produces a row of summary information in the result table. Here is
a simple example.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rsummary_node.html">rsummary_node</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/execute.html">execute</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">.</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   column index   class nrows nna nunique min max       mean       sd lexmin</span></span>
<span><span class="co">## 1      v     1 numeric     3   0      NA  -5   3 -0.3333333 4.163332     NA</span></span>
<span><span class="co">##   lexmax</span></span>
<span><span class="co">## 1     NA</span></span></code></pre>
<p>Users can add additional capabilities by writing their own
<code><a href="../reference/non_sql_node.html">non_sql_node()</a></code>s.</p>
</div>
<div class="section level2">
<h2 id="standard-interfaces">Standard interfaces<a class="anchor" aria-label="anchor" href="#standard-interfaces"></a>
</h2>
<p><code>rquery</code> goes out of its way to supply easy to program
over value-oriented interfaces. For any meta-programming we suggest
using <a href="https://winvector.github.io/wrapr/reference/let.html" class="external-link"><code>wrapr::let()</code></a>,
a powerful and <a href="https://github.com/WinVector/wrapr/blob/master/extras/wrapr_let.pdf" class="external-link">well-documented</a>
meta-programming system.</p>
</div>
<div class="section level2">
<h2 id="assignment-partitioning">Assignment partitioning<a class="anchor" aria-label="anchor" href="#assignment-partitioning"></a>
</h2>
<p><code>rquery</code> accepts many assignment in a
<code><a href="../reference/sql_node.html">sql_node()</a></code> or in a single <code>extend</code> node. The
<code>extend</code> node comes with automatic <a href="#assignment-partitioning">assignment partitioning</a> to ensure
correct and performant results. This allows the user to write large
<code>extend</code> blocks and know they will be executed correctly.</p>
<p>Here is an example.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_td.html">mk_td</a></span><span class="op">(</span><span class="st">'d4'</span>,</span>
<span>                   columns <span class="op">=</span> <span class="fu"><a href="https://winvector.github.io/wrapr//reference/qc.html" class="external-link">qc</a></span><span class="op">(</span><span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'c'</span>, <span class="st">'d'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extend.html">extend</a></span><span class="op">(</span><span class="va">.</span>, </span>
<span>             x <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>             y <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>             u <span class="op">=</span> <span class="va">b</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>             v <span class="op">=</span> <span class="va">c</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>             w <span class="op">=</span> <span class="va">d</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">ot</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## mk_td("d4", c(</span></span>
<span><span class="co">##   "a",</span></span>
<span><span class="co">##   "b",</span></span>
<span><span class="co">##   "c",</span></span>
<span><span class="co">##   "d")) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   x := a + 1,</span></span>
<span><span class="co">##   u := b + 1,</span></span>
<span><span class="co">##   v := c + 1,</span></span>
<span><span class="co">##   w := d + 1) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   y := x + 1)</span></span></code></pre>
<p>Notice the dependent assignment was moved into its own extend block.
This sort of transform is critical in getting correct results from
<code>SQL</code> (<a href="https://win-vector.com/2018/01/21/advisory-on-multiple-assignment-dplyrmutate-on-databases/" class="external-link">here</a>
is an example of what can happen when one does not correctly mitigate
this issue).</p>
<p>A node that uses the assignment partitioning and re-ordering is the
<a href="https://winvector.github.io/rquery/reference/if_else_block.html" class="external-link"><code>if_else_block()</code></a>
which can be used to simulate block-oriented if-else semantics as seen
in systems such as <code>SAS</code> (also meaning <code>rquery</code>
can be critical porting code from <code>SAS</code> to <code>SQL</code>
based <code>R</code>). This allows coordinated assignments such as the
following:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ifet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_td.html">mk_td</a></span><span class="op">(</span><span class="st">"d5"</span>,</span>
<span>                     columns <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extend_se.html">extend_se</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://winvector.github.io/wrapr//reference/qae.html" class="external-link">qae</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">''</span>,</span>
<span>                  y <span class="op">=</span> <span class="st">''</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="../reference/if_else_block.html">if_else_block</a></span><span class="op">(</span></span>
<span>                <span class="fu"><a href="https://winvector.github.io/wrapr//reference/qe.html" class="external-link">qe</a></span><span class="op">(</span><span class="va">test</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>                thenexprs <span class="op">=</span> <span class="fu"><a href="https://winvector.github.io/wrapr//reference/qae.html" class="external-link">qae</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'a'</span>, </span>
<span>                                y <span class="op">=</span> <span class="st">'b'</span><span class="op">)</span>,</span>
<span>                elseexprs <span class="op">=</span> <span class="fu"><a href="https://winvector.github.io/wrapr//reference/qae.html" class="external-link">qae</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'b'</span>, </span>
<span>                                y <span class="op">=</span> <span class="st">'a'</span><span class="op">)</span></span>
<span>              <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">ifet</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## mk_td("d5", c(</span></span>
<span><span class="co">##   "test")) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   x := "",</span></span>
<span><span class="co">##   y := "",</span></span>
<span><span class="co">##   ifebtest_1 := test &gt; 5) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   x := ifelse(ifebtest_1, "a", x),</span></span>
<span><span class="co">##   y := ifelse(ifebtest_1, "b", y)) %.&gt;%</span></span>
<span><span class="co">##  extend(.,</span></span>
<span><span class="co">##   x := ifelse(!(ifebtest_1), "b", x),</span></span>
<span><span class="co">##   y := ifelse(!(ifebtest_1), "a", y))</span></span></code></pre>
<p>As you can see, the <code><a href="../reference/if_else_block.html">if_else_block()</a></code> works by landing the
test in a column and then using that column to conditional all further
statements. <a href="https://winvector.github.io/wrapr/reference/qe.html" class="external-link"><code>qe()</code></a>
and <a href="https://winvector.github.io/wrapr/reference/qae.html" class="external-link"><code>qae()</code></a>
are quoting convenience functions. Note the <code>if_else_block</code>
depends on <code>x</code> and <code>y</code> being defined before
entering the block, as they are self-assigned ( this is checked by the
<code>extend</code> node). The <code><a href="../reference/if_else_block.html">if_else_block()</a></code> returns a
list of assignments, which then used in the <code><a href="../reference/extend_se.html">extend_se()</a></code>
statement, which in turn is re-factored into a sequence of safe extend
nodes.</p>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h2>
<p>As <code>rquery</code> pipelines are factored into stages similar to
the common relational operators they tend to be very compatible with
downstream query optimizers. We think some of the advantage is the fact
that <code>rquery</code> deliberately does not have a
<code>group_by</code> operator, but instead considers this as the
<code>partitionby</code> attribute of a <a href="https://winvector.github.io/rquery/reference/project.html" class="external-link"><code>project()</code>
node</a> (non-trivial example <a href="https://github.com/WinVector/rquery/blob/master/README.md" class="external-link">here</a>).</p>
<p>We have seen database based <code>rquery</code> outperform both
in-memory <code>dplyr</code> and database based <code>dplyr</code></p>
<blockquote>
<p><img src="runtimes_1.png"></p>
<p>(Figure from: <a href="https://win-vector.com/2018/01/09/rquery-fast-data-manipulation-in-r/" class="external-link">here</a>.)</p>
</blockquote>
<p>In addition <code>rquery</code> includes automatic column narrowing:
where only columns used to construct the final result are pulled from
initial tables. This feature is important in production (where data
marts can be quite wide) and has show significant additional performance
advantages</p>
<p>From a coding point of view the automatic narrowing effect looks like
this.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_td.html">mk_td</a></span><span class="op">(</span>table <span class="op">=</span> <span class="st">'d6'</span>,</span>
<span>                   columns <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/extend.html">extend</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">res</span> <span class="op">:=</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># full query</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="../reference/to_sql.html">to_sql</a></span><span class="op">(</span><span class="va">wp</span>, <span class="va">db</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SELECT</span></span>
<span><span class="co">##  `a`,</span></span>
<span><span class="co">##  `b`,</span></span>
<span><span class="co">##  `c`,</span></span>
<span><span class="co">##  `d`,</span></span>
<span><span class="co">##  `e`,</span></span>
<span><span class="co">##  `a` + `b`  AS `res`</span></span>
<span><span class="co">## FROM (</span></span>
<span><span class="co">##  SELECT</span></span>
<span><span class="co">##   `a`,</span></span>
<span><span class="co">##   `b`,</span></span>
<span><span class="co">##   `c`,</span></span>
<span><span class="co">##   `d`,</span></span>
<span><span class="co">##   `e`</span></span>
<span><span class="co">##  FROM</span></span>
<span><span class="co">##   `d6`</span></span>
<span><span class="co">##  ) tsql_57536422139616547568_0000000000</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># longer pipeline</span></span>
<span><span class="va">wn</span> <span class="op">&lt;-</span> <span class="va">wp</span> <span class="op"><a href="https://winvector.github.io/wrapr//reference/dot_arrow.html" class="external-link">%.&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/select_columns.html">select_columns</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"res"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># notice select at end of the pipeline automatically </span></span>
<span><span class="co"># gets propagated back to the beginning of the</span></span>
<span><span class="co"># pipeline</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="../reference/to_sql.html">to_sql</a></span><span class="op">(</span><span class="va">wn</span>, <span class="va">db</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## SELECT</span></span>
<span><span class="co">##  `res`</span></span>
<span><span class="co">## FROM (</span></span>
<span><span class="co">##  SELECT</span></span>
<span><span class="co">##   `a` + `b`  AS `res`</span></span>
<span><span class="co">##  FROM (</span></span>
<span><span class="co">##   SELECT</span></span>
<span><span class="co">##    `a`,</span></span>
<span><span class="co">##    `b`</span></span>
<span><span class="co">##   FROM</span></span>
<span><span class="co">##    `d6`</span></span>
<span><span class="co">##   ) tsql_22047897431852576914_0000000000</span></span>
<span><span class="co">## ) tsql_22047897431852576914_0000000001</span></span></code></pre>
<p>A graph of the the effects of this kind of narrowing (for
<code>dplyr</code> by hand as <code>dplyr</code> currently does not have
the above type of automatic query analysis/optimization) shows the
sensitivity to this optimization.</p>
<blockquote>
<p><img src="present-2.png"></p>
<p>(Figure from: <a href="https://github.com/WinVector/rquery/blob/master/extras/PerfTest.md" class="external-link">here</a>,
please see also <a href="https://win-vector.com/2017/12/20/how-to-greatly-speed-up-your-spark-queries/" class="external-link">here</a>.)</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code>rquery</code> is new package, but it is already proving to be
correct (avoiding <a href="https://win-vector.com/2018/01/21/advisory-on-multiple-assignment-dplyrmutate-on-databases/" class="external-link">known
data processing issues</a>) and performant. For working with
<code>R</code> at a big data scale (say using <code>PostgreSQL</code> or
<code>Spark</code>) <code>rquery</code> is the right specialized tool
for specifying data manipulation.</p>
</div>
<div class="section level2">
<h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<p>For deeper dives into specific topics, please see also:</p>
<ul>
<li><a href="https://winvector.github.io/rquery/index.html" class="external-link"><code>rquery README</code></a></li>
<li><a href="https://github.com/WinVector/rquery/blob/master/extras/JoinController.md" class="external-link">Join
Controller</a></li>
<li><a href="https://github.com/WinVector/rquery/blob/master/extras/DependencySorting.md" class="external-link">Join
Dependency Sorting</a></li>
<li><a href="https://github.com/WinVector/rquery/blob/master/extras/PerfTest.md" class="external-link">PerfTest</a></li>
<li><a href="https://github.com/WinVector/rquery/blob/master/extras/AssigmentPartitioner.md" class="external-link">Assignment
Partitioner</a></li>
<li><a href="https://github.com/WinVector/rquery/blob/master/extras/ExtraDBs.md" class="external-link">DifferentDBs</a></li>
<li><a href="https://github.com/WinVector/rqdatatable" class="external-link"><code>data.table based</code>
implementation</a></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="appendix-always-clean-up-on-the-way-out">Appendix: Always clean up on the way out<a class="anchor" aria-label="anchor" href="#appendix-always-clean-up-on-the-way-out"></a>
</h2>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">old_o</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Mount.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
